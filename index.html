<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merkez Cumhuriyet ƒ∞lkokulu Turnuva Sistemi</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;500;700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00f2ea;
            --secondary: #ff0050;
            --bg-dark: #0b0c15;
            --card-bg: #151922;
            --border: #2a2a35;
            --success: #00ff88;
            --warning: #ffd700;
            --text-main: #e0e6ed;
        }
        /* Kaydƒ±rma √áubuƒüunu Gizle */
        html, body { overflow-x: hidden; scrollbar-width: none; -ms-overflow-style: none; }
        ::-webkit-scrollbar { display: none; }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-main); min-height: 100vh; padding-bottom: 50px; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* HEADER */
        header { text-align: center; margin-bottom: 30px; padding-top: 30px; }
        h1 { font-family: 'Exo 2'; font-size: 2.5rem; font-weight: 800; background: linear-gradient(to right, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
        
        /* LOADING */
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width: 50px; height: 50px; border: 5px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* VIEW CONTAINERS */
        .view-section { display: none; animation: fadeIn 0.5s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

        /* FORM STYLES */
        .form-card { background: var(--card-bg); border: 1px solid var(--border); padding: 30px; border-radius: 16px; max-width: 500px; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #aaa; }
        input, select { width: 100%; padding: 12px; background: #0b0c15; border: 1px solid var(--border); color: #fff; border-radius: 8px; font-size: 1rem; }
        input:focus, select:focus { border-color: var(--primary); outline: none; }
        .submit-btn { width: 100%; padding: 15px; background: var(--primary); color: #000; font-weight: 800; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 242, 234, 0.3); }

        /* ADMIN DASHBOARD */
        .admin-panel { background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 30px; }
        
        .admin-add-box { background: rgba(0, 242, 234, 0.05); border: 1px dashed var(--primary); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .admin-add-row { display: flex; gap: 10px; align-items: flex-end; }
        .admin-add-row .form-group { margin-bottom: 0; flex: 1; }
        .btn-admin-add { background: var(--primary); color: #000; font-weight: bold; border: none; padding: 0 20px; height: 45px; border-radius: 8px; cursor: pointer; }

        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #000; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .stat-num { font-size: 2rem; font-weight: 800; color: var(--primary); }
        
        .player-list { max-height: 400px; overflow-y: auto; background: #000; border-radius: 8px; border: 1px solid var(--border); }
        .player-item { display: flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #222; align-items: center; }
        .player-item:last-child { border-bottom: none; }
        .del-btn { background: var(--secondary); color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }

        .action-bar { display: flex; gap: 10px; margin-top: 20px; }
        .action-btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .btn-start { background: var(--success); color: #000; }
        .btn-close { background: var(--warning); color: #000; }
        .btn-reset { background: var(--danger); color: #fff; }

        /* TURNUVA G√ñR√úN√úM√ú */
        .bracket-container { display: flex; flex-direction: column; gap: 30px; }
        .round-block { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .round-title { text-align: center; color: var(--warning); font-size: 1.5rem; font-weight: 800; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .matches-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .match-card { background: #16181e; border: 1px solid var(--border); border-radius: 8px; padding: 10px; position: relative; }
        .match-card.completed { border-color: var(--success); }
        .status-badge { position: absolute; top: -8px; right: 10px; font-size: 0.7rem; background: var(--success); color: #000; padding: 2px 8px; border-radius: 8px; font-weight: 800; display: none; }
        .match-card.completed .status-badge { display: block; }
        .player-row { display: flex; justify-content: space-between; padding: 8px 10px; background: rgba(255,255,255,0.03); margin-bottom: 5px; border-radius: 4px; align-items: center; }
        .player-row.winner { background: rgba(0, 255, 136, 0.15); border-left: 4px solid var(--success); }
        .p-name { font-weight: 700; color: #fff; font-size: 0.95rem; }
        .p-class { font-size: 0.8rem; color: #ff9f43; margin-left: auto; padding-left: 10px; }
        .score-val { font-weight: 800; font-size: 1.2rem; width: 30px; text-align: center; }
        .btn-s { width: 24px; height: 24px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; margin: 0 2px; }
        .btn-plus { background: var(--primary); }
        .btn-minus { background: #333; color: #fff; }
        
        .game-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 25px; background: transparent; border: 1px solid var(--border); color: #888; border-radius: 50px; cursor: pointer; }
        .tab-btn.active { border-color: var(--primary); color: #fff; background: rgba(0, 242, 234, 0.1); }

        .admin-login-btn { position: fixed; bottom: 10px; right: 10px; opacity: 0.3; cursor: pointer; background: none; border: none; color: #fff; font-size: 1.5rem; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="color:#fff; font-weight:600">Veriler Y√ºkleniyor...</div>
</div>

<div class="container">
    <header>
        <h1>MERKEZ CUMHURƒ∞YET ƒ∞LKOKULU</h1>
        <h3 style="color:#888; letter-spacing:2px;">TURNUVA Y√ñNETƒ∞M Sƒ∞STEMƒ∞</h3>
    </header>

    <!-- 1. KAYIT EKRANI (Ziyaret√ßi) -->
    <div id="registration-view" class="view-section">
        <div class="announcement-box" style="text-align:center; margin-bottom:20px;">
            <h2 style="color:var(--primary); margin-bottom:10px;">KAYITLAR A√áIK</h2>
            <p>A≈üaƒüƒ±daki formu doldurarak turnuvaya katƒ±labilirsiniz.</p>
        </div>
        <div class="form-card">
            <div class="form-group">
                <label>Oyun Se√ßiniz</label>
                <select id="reg-game">
                    <option value="2">Abluka</option>
                    <option value="4">Equilibrio</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ad Soyad</label>
                <input type="text" id="reg-name" placeholder="√ñrn: Ahmet Yƒ±lmaz" autocomplete="off">
            </div>
            <div class="form-group">
                <label>Sƒ±nƒ±f</label>
                <input type="text" id="reg-class" placeholder="√ñrn: 4/A" autocomplete="off">
            </div>
            <button class="submit-btn" onclick="registerStudent()">KAYIT OL</button>
        </div>
    </div>

    <!-- 2. BEKLEME EKRANI (Kayƒ±tlar Kapandƒ±ysa) -->
    <div id="waiting-view" class="view-section">
        <div class="form-card" style="text-align:center;">
            <i class="fas fa-clock" style="font-size:3rem; color:var(--warning); margin-bottom:20px;"></i>
            <h2>Kayƒ±tlar Kapandƒ±</h2>
            <p style="color:#aaa; margin-top:10px;">Turnuva e≈üle≈ümeleri hazƒ±rlanƒ±yor. L√ºtfen bekleyiniz.</p>
        </div>
    </div>

    <!-- 3. TURNUVA ƒ∞ZLEME EKRANI (Ziyaret√ßi & Admin) -->
    <div id="tournament-view" class="view-section">
        <div class="game-tabs" id="game-tabs">
            <!-- Oyun butonlarƒ± buraya gelecek -->
        </div>
        <div id="bracket-area" class="bracket-container"></div>
    </div>

    <!-- 4. ADMIN PANELƒ∞ (Sadece Giri≈ü Yapanlar) -->
    <div id="admin-view" class="view-section">
        <div class="admin-panel">
            <h2 style="margin-bottom:20px; color:var(--primary)">Y√ñNETƒ∞Cƒ∞ PANELƒ∞</h2>
            
            <div class="admin-add-box">
                <h4 style="margin-bottom:10px; color:#fff"><i class="fas fa-plus-circle"></i> Manuel Kayƒ±t Ekle</h4>
                <div class="admin-add-row">
                    <div class="form-group">
                        <select id="admin-reg-game">
                            <option value="2">Abluka</option>
                            <option value="4">Equilibrio</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="text" id="admin-reg-name" placeholder="Ad Soyad">
                    </div>
                    <div class="form-group">
                        <input type="text" id="admin-reg-class" placeholder="Sƒ±nƒ±f">
                    </div>
                    <button class="btn-admin-add" onclick="adminRegisterStudent()">EKLE</button>
                </div>
            </div>

            <div class="stat-grid">
                <div class="stat-card">
                    <div>Abluka Kayƒ±t</div>
                    <div class="stat-num" id="count-abluka">0</div>
                </div>
                <div class="stat-card">
                    <div>Equilibrio Kayƒ±t</div>
                    <div class="stat-num" id="count-equilibrio">0</div>
                </div>
                <div class="stat-card">
                    <div>Durum</div>
                    <div class="stat-num" id="status-text" style="font-size:1.2rem; line-height:2.5rem">-</div>
                </div>
            </div>

            <div style="margin-bottom:10px; font-weight:bold;">Kayƒ±t Listesi:</div>
            <div class="player-list" id="admin-player-list"></div>

            <div class="action-bar">
                <button class="action-btn btn-close" onclick="changeStatus('closed')">KAYITLARI KAPAT</button>
                <button class="action-btn btn-start" onclick="startTournament()">TURNUVAYI BA≈ûLAT</button>
                <button class="action-btn btn-reset" onclick="resetSystem()">SIFIRLA</button>
            </div>
            
            <div style="margin-top:20px; text-align:center;">
                <button class="tab-btn" onclick="showTournamentViewAdmin()">TURNUVA EKRANINA Gƒ∞T (Skor Giri≈üi)</button>
            </div>
        </div>
    </div>

</div>

<button class="admin-login-btn" onclick="adminLogin()"><i class="fas fa-lock"></i></button>

<script>
    // --- JSONBIN AYARLARI ---
    const BIN_ID = "69663710ae596e708fd967a0"; 
    const API_KEY = "$2a$10$jyaUVJ4i7lf8QTCnEWTlpesulUPPq0rODrO1Yy/ljOVLKy.FVU1M2"; 

    // --- BA≈ûLANGI√á VERƒ∞LERƒ∞ (Sƒ∞Zƒ∞N VERDƒ∞ƒûƒ∞Nƒ∞Z Lƒ∞STE) ---
    const BASE_PLAYERS = [
        // ABLUKA (15 Ki≈üi)
        { name: "SALƒ∞H ERDEM YAZAR", class: "2/E", gameId: 2 },
        { name: "Yƒ∞ƒûƒ∞T HAMZA CENGƒ∞Z", class: "2/E", gameId: 2 },
        { name: "√ñYK√ú Tƒ∞RYAKƒ∞", class: "4/A", gameId: 2 },
        { name: "AZRA TOROS", class: "4/A", gameId: 2 },
        { name: "ALƒ∞ AYAZ KAZAN", class: "3/B", gameId: 2 },
        { name: "SONG√úL ESMA AƒûBULUT", class: "3/D", gameId: 2 },
        { name: "√ñMER KA≈ûIK√áI", class: "2/D", gameId: 2 },
        { name: "√ñZNUR DUMAN", class: "3/D", gameId: 2 },
        { name: "MEMDUHA NEHƒ∞R K√ñKSALAN", class: "3/D", gameId: 2 },
        { name: "HAMZA MUSUL", class: "4/F", gameId: 2 },
        { name: "POYRAZ LA√áƒ∞NKAYA", class: "4/F", gameId: 2 },
        { name: "AZƒ∞Z MUHARREM ATƒ∞LA", class: "3/D", gameId: 2 },
        { name: "HAYRUNNƒ∞SA √áE√áEN", class: "2/E", gameId: 2 },
        { name: "√úMRA SUNA KALELƒ∞", class: "4/A", gameId: 2 },
        { name: "DEFNE SULUOƒûLU", class: "4/A", gameId: 2 },

        // EQUILIBRIO (15 Ki≈üi)
        { name: "ECRƒ∞N √áAKIR", class: "4/E", gameId: 4 },
        { name: "YAƒûMUR KIZIL", class: "4/F", gameId: 4 },
        { name: "MUHAMMED EMƒ∞R KO√áAK", class: "2/E", gameId: 4 },
        { name: "ENES G√úZEL", class: "4/D", gameId: 4 },
        { name: "AY≈ûENUR YILMAZ", class: "2/A", gameId: 4 },
        { name: "AMƒ∞NE BAHADIR", class: "4/F", gameId: 4 },
        { name: "ALƒ∞ AYAZ KAZAN", class: "3/B", gameId: 4 },
        { name: "SONG√úL ESMA AƒûBULUT", class: "3/D", gameId: 4 },
        { name: "YAVUZ SELƒ∞M G√úNE≈û", class: "3/D", gameId: 4 },
        { name: "MELƒ∞SA √áANKAYA", class: "3/D", gameId: 4 },
        { name: "√ñMER KA≈ûIK√áI", class: "2/D", gameId: 4 },
        { name: "√ñZNUR DUMAN", class: "3/D", gameId: 4 },
        { name: "HAMZA MUSUL", class: "4/F", gameId: 4 },
        { name: "POYRAZ LA√áƒ∞NKAYA", class: "4/F", gameId: 4 },
        { name: "HAYRUNNƒ∞SA √áE√áEN", class: "2/E", gameId: 4 }
    ];

    const GAMES = [
        { id: 2, name: "Abluka" },
        { id: 4, name: "Equilibrio" }
    ];

    let systemData = {
        status: "registration",
        players: [...BASE_PLAYERS], 
        brackets: {} 
    };

    let isAdmin = false;
    let activeTabGameId = 2;

    // --- BA≈ûLANGI√á ---
    window.onload = async () => {
        await loadData();
        setInterval(loadData, 5000); 
    };

    async function loadData() {
        try {
            if(BIN_ID.length < 5) {
                const local = localStorage.getItem('merkezV24');
                if(local) systemData = JSON.parse(local);
                updateUI();
                document.getElementById('loading-overlay').style.display = 'none';
                return;
            }

            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                headers: { 'X-Master-Key': API_KEY }
            });
            if(res.ok) {
                const json = await res.json();
                if (Object.keys(json.record).length === 0) {
                    await saveData(); 
                } else {
                    systemData = json.record;
                }
                updateUI();
            }
        } catch(e) { console.error(e); }
        document.getElementById('loading-overlay').style.display = 'none';
    }

    async function saveData() {
        document.getElementById('loading-overlay').style.display = 'flex';
        try {
            if(BIN_ID.length < 5) {
                localStorage.setItem('merkezV24', JSON.stringify(systemData));
            } else {
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify(systemData)
                });
            }
        } catch(e) { alert("Kaydetme hatasƒ±!"); }
        document.getElementById('loading-overlay').style.display = 'none';
        updateUI();
    }

    // --- UI G√úNCELLEME ---
    function updateUI() {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));

        if (isAdmin) {
            document.getElementById('admin-view').classList.add('active');
            renderAdminPanel();
        } else {
            if (systemData.status === 'registration') {
                document.getElementById('registration-view').classList.add('active');
            } else if (systemData.status === 'closed') {
                document.getElementById('waiting-view').classList.add('active');
            } else if (systemData.status === 'active') {
                document.getElementById('tournament-view').classList.add('active');
                renderTournamentTabs();
                renderBracket(activeTabGameId);
            }
        }
    }

    // --- Zƒ∞YARET√áƒ∞ KAYIT ---
    async function registerStudent() {
        const name = document.getElementById('reg-name').value.trim().toUpperCase();
        const sClass = document.getElementById('reg-class').value.trim().toUpperCase();
        const gameId = parseInt(document.getElementById('reg-game').value);

        if(!name || !sClass) { alert("L√ºtfen t√ºm alanlarƒ± doldurun."); return; }

        const exists = systemData.players.some(p => p.name === name && p.class === sClass && p.gameId === gameId);
        if(exists) { alert("Bu √∂ƒürenci zaten bu oyuna kayƒ±tlƒ±!"); return; }

        systemData.players.push({ name, class: sClass, gameId });
        alert("Kayƒ±t Ba≈üarƒ±lƒ±!");
        
        document.getElementById('reg-name').value = "";
        document.getElementById('reg-class').value = "";
        
        await saveData();
    }

    // --- ADMƒ∞N KAYIT ---
    async function adminRegisterStudent() {
        const name = document.getElementById('admin-reg-name').value.trim().toUpperCase();
        const sClass = document.getElementById('admin-reg-class').value.trim().toUpperCase();
        const gameId = parseInt(document.getElementById('admin-reg-game').value);

        if(!name || !sClass) { alert("ƒ∞sim ve Sƒ±nƒ±f giriniz."); return; }

        const exists = systemData.players.some(p => p.name === name && p.class === sClass && p.gameId === gameId);
        if(exists) { alert("Zaten kayƒ±tlƒ±!"); return; }

        systemData.players.push({ name, class: sClass, gameId });
        alert("Manuel kayƒ±t eklendi.");
        
        document.getElementById('admin-reg-name').value = "";
        document.getElementById('admin-reg-class').value = "";
        
        await saveData();
    }

    function adminLogin() {
        const pass = prompt("Kurum Kodu:");
        if(pass === "853256") {
            isAdmin = true;
            updateUI();
        } else {
            alert("Hatalƒ± ≈ûifre");
        }
    }

    function renderAdminPanel() {
        document.getElementById('count-abluka').innerText = systemData.players.filter(p => p.gameId === 2).length;
        document.getElementById('count-equilibrio').innerText = systemData.players.filter(p => p.gameId === 4).length;
        
        let statusText = "Kayƒ±t A√ßƒ±k";
        if(systemData.status === 'closed') statusText = "Kayƒ±t Kapalƒ±";
        if(systemData.status === 'active') statusText = "Turnuva Ba≈üladƒ±";
        document.getElementById('status-text').innerText = statusText;

        const listEl = document.getElementById('admin-player-list');
        listEl.innerHTML = '';
        systemData.players.forEach((p, index) => {
            const gameObj = GAMES.find(g => g.id === p.gameId);
            const gameName = gameObj ? gameObj.name : "Bilinmeyen";
            listEl.innerHTML += `
                <div class="player-item">
                    <div>
                        <strong>${p.name}</strong> <span style="color:#aaa">(${p.class})</span>
                        <span style="color:var(--primary); font-size:0.8rem; margin-left:10px;">${gameName}</span>
                    </div>
                    <button class="del-btn" onclick="deletePlayer(${index})">Sil</button>
                </div>`;
        });
    }

    async function deletePlayer(index) {
        if(confirm("Bu kaydƒ± silmek istediƒüinize emin misiniz?")) {
            systemData.players.splice(index, 1);
            await saveData();
        }
    }

    async function changeStatus(newStatus) {
        systemData.status = newStatus;
        await saveData();
    }

    async function resetSystem() {
        if(confirm("Dƒ∞KKAT: T√ºm yeni kayƒ±tlar silinecek ve sistem ba≈üa d√∂necek!")) {
            systemData.status = 'registration';
            systemData.players = [...BASE_PLAYERS]; 
            systemData.brackets = {};
            await saveData();
        }
    }

    async function startTournament() {
        if(confirm("Turnuva ba≈ülatƒ±lacak ve kuralar √ßekilecek. Onaylƒ±yor musunuz?")) {
            systemData.brackets = {};
            
            GAMES.forEach(game => {
                const participants = systemData.players.filter(p => p.gameId === game.id);
                participants.sort(() => Math.random() - 0.5);
                systemData.brackets[game.id] = generateBracket(participants);
            });

            systemData.status = 'active';
            await saveData();
        }
    }

    function generateBracket(participants) {
        const rounds = [];
        let matches = [];
        let power = 1;
        while(power < participants.length) power *= 2;
        const totalSlots = power;
        
        let pIndex = 0;
        for(let i=0; i<totalSlots/2; i++) {
            let p1 = participants[pIndex++] || null;
            let p2 = participants[pIndex++] || null;
            
            matches.push({ 
                id: Math.random().toString(36).substr(2, 9),
                p1: p1, p2: p2, s1: 0, s2: 0, 
                winner: (!p2 && p1) ? p1 : null 
            });
        }
        rounds.push(matches);

        let matchCount = matches.length;
        while(matchCount > 1) {
            matchCount /= 2;
            let nextRound = [];
            for(let i=0; i<matchCount; i++) {
                nextRound.push({ 
                    id: Math.random().toString(36).substr(2, 9),
                    p1: null, p2: null, s1:0, s2:0, winner: null 
                });
            }
            rounds.push(nextRound);
        }
        return rounds;
    }

    function showTournamentViewAdmin() {
        document.getElementById('admin-view').classList.remove('active');
        document.getElementById('tournament-view').classList.add('active');
        renderTournamentTabs();
        renderBracket(activeTabGameId);
    }

    function renderTournamentTabs() {
        const container = document.getElementById('game-tabs');
        container.innerHTML = '';
        GAMES.forEach(g => {
            container.innerHTML += `<button class="tab-btn ${g.id === activeTabGameId ? 'active' : ''}" onclick="switchTab(${g.id})">${g.name}</button>`;
        });
    }

    function switchTab(id) {
        activeTabGameId = id;
        renderTournamentTabs();
        renderBracket(id);
    }

    function renderBracket(gameId) {
        const rounds = systemData.brackets[gameId];
        if(!rounds) return;

        const container = document.getElementById('bracket-area');
        container.innerHTML = '';

        rounds.forEach((round, rIndex) => {
            let title = `${rIndex + 1}. TUR`;
            if(rIndex === rounds.length - 1) title = "üèÜ Fƒ∞NAL";
            else if(rIndex === rounds.length - 2) title = "YARI Fƒ∞NAL";

            let html = `<div class="round-block">
                <div class="round-title">${title}</div>
                <div class="matches-grid">`;
            
            round.forEach((match, mIndex) => {
                const isCompleted = match.winner !== null;
                const p1Name = match.p1 ? match.p1.name : '...';
                const p2Name = match.p2 ? match.p2.name : '...';
                const p1Class = match.p1 ? match.p1.class : '';
                const p2Class = match.p2 ? match.p2.class : '';
                
                let controls1 = '', controls2 = '';
                if(isAdmin && !match.winner && match.p1 && match.p2) {
                    controls1 = `<div class="score-controls"><button class="btn-s btn-minus" onclick="updateScore(${gameId}, ${rIndex}, ${mIndex}, 1, -1)">-</button><button class="btn-s btn-plus" onclick="updateScore(${gameId}, ${rIndex}, ${mIndex}, 1, 1)">+</button></div>`;
                    controls2 = `<div class="score-controls"><button class="btn-s btn-minus" onclick="updateScore(${gameId}, ${rIndex}, ${mIndex}, 2, -1)">-</button><button class="btn-s btn-plus" onclick="updateScore(${gameId}, ${rIndex}, ${mIndex}, 2, 1)">+</button></div>`;
                }

                html += `
                <div class="match-card ${isCompleted ? 'completed' : ''}">
                    ${isCompleted ? '<div class="status-badge">Bƒ∞TTƒ∞</div>' : ''}
                    
                    <div class="player-row ${match.winner && match.winner.name === p1Name ? 'winner' : ''}">
                        <div>
                            <div class="p-name">${p1Name}</div>
                            <div class="p-class">${p1Class}</div>
                        </div>
                        <div style="display:flex;align-items:center;gap:5px;">
                            ${controls1}
                            <div class="score-val">${match.s1}</div>
                        </div>
                    </div>

                    <div class="player-row ${match.winner && match.winner.name === p2Name ? 'winner' : ''}">
                        <div>
                            <div class="p-name">${p2Name}</div>
                            <div class="p-class">${p2Class}</div>
                        </div>
                        <div style="display:flex;align-items:center;gap:5px;">
                            ${controls2}
                            <div class="score-val">${match.s2}</div>
                        </div>
                    </div>
                </div>`;
            });

            html += `</div></div>`;
            container.innerHTML += html;
        });
    }

    async function updateScore(gId, rIdx, mIdx, pNum, change) {
        const match = systemData.brackets[gId][rIdx][mIdx];
        
        if (pNum === 1) match.s1 = Math.max(0, match.s1 + change);
        else match.s2 = Math.max(0, match.s2 + change);

        if (match.s1 >= 2) { match.winner = match.p1; advanceWinner(gId, rIdx, mIdx, match.p1); }
        else if (match.s2 >= 2) { match.winner = match.p2; advanceWinner(gId, rIdx, mIdx, match.p2); }
        else { match.winner = null; } 

        await saveData();
    }

    function advanceWinner(gId, rIdx, mIdx, winner) {
        const nextRIdx = rIdx + 1;
        if (nextRIdx < systemData.brackets[gId].length) {
            const nextMIdx = Math.floor(mIdx / 2);
            const isTopSlot = (mIdx % 2 === 0);
            const nextMatch = systemData.brackets[gId][nextRIdx][nextMIdx];
            
            if (isTopSlot) nextMatch.p1 = winner;
            else nextMatch.p2 = winner;
        }
    }
</script>
</body>
</html>
